<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QEMU GPU Passthrough Methodology</title>
      <meta name="author" content="C.J. Wade">
      <meta name="date" content="2022-10-08T13:27:14-05:00">
      <link rel="stylesheet" href="/css/style.css">
    </head>
<body>
    <!-- Default header if you want one -->
  
  <main>
        <header>
      <h1>QEMU GPU Passthrough Methodology</h1>
            <p class="date">2022-10-08T13:27:14-05:00</p>
                  <p class="author">By C.J. Wade</p>
          </header>
    
    
    <section id="qemu-gpu-passthrough-methodology" class="level1">
    <h1>QEMU GPU Passthrough Methodology</h1>
    <p>The following are the steps that I take in order to set up a
    Windows, specifically 11, virtual machine under Pop!_OS Linux.</p>
    <ol type="1">
    <li><p>If I am working with a new install of Pop!_OS, I run this <a
    href="https://github.com/pavolelsig/Passthrough_helper_PopOS">script</a>
    from Pavol Elsig. It takes all the grunt work out of hiding your GPU
    from the host os.</p></li>
    <li><p>I then follow this <a
    href="https://christitus.com/vm-setup-in-linux/">guide</a> from
    Chris Titus. It walks you through installing the necessary packages,
    as well as some tweaks for networking and allowing your
    <code>$USER</code> to access the virtualization packages.</p></li>
    <li><p>Use <code>virt-manager</code> to create a new virtual
    machine. Before beginning the installation, copy your Windows 11 iso
    file to <code>/var/lib/libvirt/images/</code>. You will need root
    privileges. I would recommend that you download the <a
    href="https://github.com/virtio-win/virtio-win-pkg-scripts">latest
    virtio-win driver iso</a>, and place it in the same directory as the
    Windows 11 iso.</p>
    <ol type="1">
    <li><p>Choose <code>Local install media.</code></p></li>
    <li><p>Select your guest os iso file. <code>virt-manager</code> will
    auto-detect what os the iso is.</p></li>
    <li><p>Give the virtual machine the amount of RAM that you want.
    Leave the CPUs field as it is for now.</p></li>
    <li><p>Personally, I like to passthrough a physical disk for the
    guest using the <code>Select or create custom storage</code>
    field.</p></li>
    <li><p>Name the virtual machine a name that is easily identifible,
    and select
    <code>Customize configuration before install</code>.</p></li>
    </ol></li>
    <li><p>On the overview tab, I select the
    <code>OVMF_CODE_4M.secboot.fd</code> firmware.</p></li>
    <li><p>On the CPUs tab, I click on <code>Topology</code>, then
    <code>Manually set CPU topology</code>. I choose 1 for
    <code>sockets</code>, put in half of my physical CPU cores for
    <code>cores</code>, and give each core two threads for
    <code>threads</code>.</p></li>
    </ol>
    <figure>
    <img src="/images/2022/virt-manager_cpu_tab.png"
    alt="virt-manager CPU Tab" />
    <figcaption aria-hidden="true">virt-manager CPU Tab</figcaption>
    </figure>
    <ol start="6" type="1">
    <li><p>I remove the NIC device. Doing this will allow you to make a
    local account instead of being forced to make a Microsoft
    account.</p></li>
    <li><p>Then click the <code>Add Hardware</code> and add the GPU and
    the GPU audio device one after the other. Also add another CDROM
    drive and put the virtio-win iso in it.</p></li>
    <li><p>Now for a little tinkering. Click on the
    <code>Overview</code> tab, then the <code>XML</code> sub-tab. Under
    the <code>&lt;vcpu&gt;</code> tags, you can add
    <code>&lt;cputune&gt;</code> tags to pin certain cores of your CPU
    to the virtual machine to improve performance. This
    <strong>will</strong> differ from machine to machine (you can check
    your system by running <code>lscpu -e</code>), but I have chosen to
    pin half my CPU cores as follows.</p></li>
    </ol>
    <div class="sourceCode" id="cb1"><pre
    class="sourceCode xml"><code class="sourceCode xml"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">cputune</span>&gt;</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">vcpupin</span><span class="ot"> vcpu=</span><span class="st">&quot;0&quot;</span><span class="ot"> cpuset=</span><span class="st">&quot;6&quot;</span>/&gt;</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">vcpupin</span><span class="ot"> vcpu=</span><span class="st">&quot;1&quot;</span><span class="ot"> cpuset=</span><span class="st">&quot;7&quot;</span>/&gt;</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">vcpupin</span><span class="ot"> vcpu=</span><span class="st">&quot;2&quot;</span><span class="ot"> cpuset=</span><span class="st">&quot;8&quot;</span>/&gt;</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">vcpupin</span><span class="ot"> vcpu=</span><span class="st">&quot;3&quot;</span><span class="ot"> cpuset=</span><span class="st">&quot;9&quot;</span>/&gt;</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">vcpupin</span><span class="ot"> vcpu=</span><span class="st">&quot;4&quot;</span><span class="ot"> cpuset=</span><span class="st">&quot;10&quot;</span>/&gt;</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">vcpupin</span><span class="ot"> vcpu=</span><span class="st">&quot;5&quot;</span><span class="ot"> cpuset=</span><span class="st">&quot;11&quot;</span>/&gt;</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">cputune</span>&gt;</span></code></pre></div>
    <ol start="9" type="1">
    <li>Sometimes when NVIDIA GPUs detect that they are running in a vm,
    they will respond with a <code>CODE 43</code> error and refuse to
    work. NVIDIA has shown that they are becoming more lax with this
    behavior, but just for peace of mind, I recommend that you add the
    following between the <code>&lt;features&gt;</code> tags.</li>
    </ol>
    <div class="sourceCode" id="cb2"><pre
    class="sourceCode xml"><code class="sourceCode xml"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>&lt;<span class="kw">features</span>&gt;</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">acpi</span>/&gt;</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">apic</span>/&gt;</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">hyperv</span><span class="ot"> mode=</span><span class="st">&quot;custom&quot;</span>&gt;</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">relaxed</span><span class="ot"> state=</span><span class="st">&quot;on&quot;</span>/&gt;</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">vapic</span><span class="ot"> state=</span><span class="st">&quot;on&quot;</span>/&gt;</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">spinlocks</span><span class="ot"> state=</span><span class="st">&quot;on&quot;</span><span class="ot"> retries=</span><span class="st">&quot;8191&quot;</span>/&gt;</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">vpindex</span><span class="ot"> state=</span><span class="st">&quot;on&quot;</span>/&gt;</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">runtime</span><span class="ot"> state=</span><span class="st">&quot;on&quot;</span>/&gt;</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">synic</span><span class="ot"> state=</span><span class="st">&quot;on&quot;</span>/&gt;</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">stimer</span><span class="ot"> state=</span><span class="st">&quot;on&quot;</span>/&gt;</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">reset</span><span class="ot"> state=</span><span class="st">&quot;on&quot;</span>/&gt;</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">vendor_id</span><span class="ot"> state=</span><span class="st">&quot;on&quot;</span><span class="ot"> value=</span><span class="st">&quot;123456879ab&quot;</span>/&gt;</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">hyperv</span>&gt;</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">kvm</span>&gt;</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    &lt;<span class="kw">hidden</span><span class="ot"> state=</span><span class="st">&quot;on&quot;</span>&gt;</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  &lt;/<span class="kw">kvm</span>&gt;</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">vmport</span><span class="ot"> state=</span><span class="st">&quot;off&quot;</span>/&gt;</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">smm</span><span class="ot"> state=</span><span class="st">&quot;on&quot;</span>/&gt;</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  &lt;<span class="kw">ioapic</span><span class="ot"> driver=</span><span class="st">&quot;kvm&quot;</span>&gt;</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>&lt;/<span class="kw">features</span>&gt;</span></code></pre></div>
    <ol start="10" type="1">
    <li><p>Now move to the <code>Boot Options</code> tab and make sure
    that the CDROM is set higher than the drive you are installing
    Windows to. Now you can click the <code>Begin Installation</code>
    button and install Windows! (Tip: click)</p></li>
    <li><p>After Windows is installed, shut it down, go back, and re-add
    the <code>nic</code>. The default options should be find.</p></li>
    <li><p>Turn on the virtual machine, and install the 64-bit msi on
    the root of the virtio-win disc. You’re basically installing this
    instead of drivers from your CPU or motherboard manufacturer’s
    website.</p></li>
    <li><p>We can now open the Microsoft Store, go to the
    <code>Downloads and Updates</code> section, and make sure that the
    program <code>App Install</code> is up-to-date.</p></li>
    <li><p>Then open either <code>Windows Terminal</code> or
    <code>Powershell</code> as administrator and run the command
    <code>iwr -useb https://christitus.com/win | iex</code>. This is a
    <a href="https://github.com/ChrisTitusTech/winutil">script</a> by
    Chris Titus that disables a lot of Window’s builtin telemetry and
    inane default settings as well as automatically installs programs
    from the internet.</p></li>
    <li><p>There are many things that this script allows you to do, but
    the main thing as far as GPUs are concerned is under the
    <code>Updates</code> tab. Select the <code>Desktop</code> preset at
    the top of the screen and let the script go to work. (NOTE: It is
    incredibility important to run the script before you install updates
    from Windows Updates. In my experience, it will download updates
    that led to the dreaded <code>CODE 43</code> error.)</p></li>
    <li><p>You can now go to the <code>Settings</code> app and check for
    updates. It is a good thing if Windows Update does not automatically
    install drivers for the GPU, as the script disabled that
    functionality. You should now go and download the drivers for your
    GPU from the manufacturer’s website.</p></li>
    <li><p>If your GPU starts displaying video then you are
    done!</p></li>
    </ol>
    <p>Hopefully now you know how to setup a GPU accelerate virutal
    machine on Linux. It can be quite the handy skill both for the
    tinkerer and the professional!</p>
    </section>
  </main>

    <!-- Default footer if you want one -->
  </body>
</html>
